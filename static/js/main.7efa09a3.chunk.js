(this.webpackJsonpannotator=this.webpackJsonpannotator||[]).push([[0],{10:function(t,e,n){t.exports=n(11)},11:function(t,e,n){"use strict";n.r(e);var a=n(2),o=n(3),i=n(5),s=n(4),r=n(1),l=n(6),c=n(0),u=n.n(c),h=n(8),d=n.n(h),m=n(9),p=n.n(m),f=(n(16),function(t){function e(t){var n;return Object(a.a)(this,e),(n=Object(i.a)(this,Object(s.a)(e).call(this,t))).state={history:[],pixelDataHU:[],pixelDataGray:[],dicomLoaded:!1,dicomFilename:"-",windowCenter:null,windowWidth:null,width:512,height:512,xPos:null,yPos:null},n.addPoint=n.addPoint.bind(Object(r.a)(n)),n.updateCoordinates=n.updateCoordinates.bind(Object(r.a)(n)),n.undoHistory=n.undoHistory.bind(Object(r.a)(n)),n.handleKeyDown=n.handleKeyDown.bind(Object(r.a)(n)),n.getCurrentContours=n.getCurrentContours.bind(Object(r.a)(n)),n.getIntensity=n.getIntensity.bind(Object(r.a)(n)),n.incrementContours=n.incrementContours.bind(Object(r.a)(n)),n.loadDicom=n.loadDicom.bind(Object(r.a)(n)),n}return Object(l.a)(e,t),Object(o.a)(e,[{key:"handleKeyDown",value:function(t){27===t.keyCode?this.undoHistory():78===t.keyCode&&t.ctrlKey&&this.incrementContours()}},{key:"componentDidMount",value:function(){document.addEventListener("keydown",this.handleKeyDown,!1)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keydown",this.handleKeyDown,!1)}},{key:"undoHistory",value:function(){var t=this.state.history;this.setState({history:t.slice(0,-1),dicomDrawn:!1})}},{key:"incrementContours",value:function(){var t=this.state.history;if(console.log(t),t.length>0){var e=t[t.length-1],n=e.currentContourIdx,a=e.contours[n];if(a&&g(a)){var o=n+1;this.setState({history:t.concat({contours:e.contours.slice(),currentContourIdx:o})})}}}},{key:"addPoint",value:function(t,e){if(0===this.state.pixelDataGray.length)return console.log("please upload DICOM file"),0;var n=this.state.history,a=[];if(0===n.length)a=[[[t,e]]],this.setState({history:n.concat({contours:a,currentContourIdx:0})});else{var o=n[n.length-1],i=o.currentContourIdx,s=o.contours.slice();i===o.contours.length-1?s[i]=s[i].concat([[t,e]]):s=s.concat([[[t,e]]]),this.setState({history:n.concat({contours:s,currentContourIdx:i})})}}},{key:"updateCoordinates",value:function(t,e){this.setState({xPos:t,yPos:e})}},{key:"getCurrentContours",value:function(){return this.state.history.length>0?this.state.history[this.state.history.length-1].contours:[]}},{key:"getIntensity",value:function(t,e){if(console.log("entrou"),0!==this.state.pixelDataHU.length&&-1!==this.state.xPos&&-1!==this.state.yPos){var n=this.state.xPos+this.state.yPos*this.state.width;return this.state.pixelDataHU[n]}return null}},{key:"loadDicom",value:function(t){var e=this,n=new FileReader;n.onload=function(n){var a=n.target.result;!function(t,n){e.updateDicomImage(t,n)}(new Uint8Array(a),t.name.slice(0,-4))},n.readAsArrayBuffer(t)}},{key:"updateDicomImage",value:function(t,e){var n=p.a.parseDicom(t),a=n.elements.x7fe00010,o=parseInt(n.uint16("x00280010")),i=parseInt(n.uint16("x00280011")),s=parseFloat(n.string("x00281050")),r=parseFloat(n.string("x00281051")),l=parseInt(n.string("x00281052")),c=parseInt(n.string("x00281053")),u=new Uint16Array(n.byteArray.buffer,a.dataOffset,a.length/2),h=Int32Array.from(u,(function(t){return t*c+l})),d=this.quantize(h,s,r);this.setState({history:[],pixelDataHU:h,pixelDataGray:d,dicomLoaded:!0,windowCenter:s,windowWidth:r,dicomFilename:e,width:i,height:o})}},{key:"quantize",value:function(t,e,n){var a=e-.5*n,o=e+.5*n,i=t.map((function(t){return t>o?o:t<a?a:t}));return Uint8Array.from(i,(function(t){return 255*(t-a)/n}))}},{key:"grayscaleToRGBA",value:function(t){for(var e=new Uint8ClampedArray(this.state.width*this.state.height*4),n=0;n<t.length;n++){var a=4*n;e[a]=t[n],e[a+1]=t[n],e[a+2]=t[n],e[a+3]=1}return e}},{key:"render",value:function(){return u.a.createElement("div",{className:"annotator"},u.a.createElement("div",{className:"titlebox"},"DICOM Annotator App"),u.a.createElement("div",{className:"workingbox"},u.a.createElement(v,{history:this.state.history,width:this.state.width,height:this.state.height,fileName:this.state.dicomFilename,pixelDataGray:this.state.pixelDataGray,dicomLoaded:this.state.dicomLoaded,onAddPoint:this.addPoint,onMouseMove:this.updateCoordinates}),u.a.createElement(y,{wc:this.state.windowCenter,ww:this.state.windowWidth,xPos:this.state.xPos,yPos:this.state.yPos,fileName:this.state.dicomFilename,hu:this.getIntensity(),currentContours:this.getCurrentContours(),onAnnotationDownlod:this.incrementContours,onUploadFile:this.loadDicom})),u.a.createElement("div",{className:"footerbox"},"Mouse left-click: annotate",u.a.createElement("br",null),"Esc: undo ",u.a.createElement("br",null),"Ctrl+N: create new annotation"))}}]),e}(u.a.Component)),v=function(t){function e(t){var n;return Object(a.a)(this,e),(n=Object(i.a)(this,Object(s.a)(e).call(this,t))).handleMouseDown=n.handleMouseDown.bind(Object(r.a)(n)),n.handleMouseMove=n.handleMouseMove.bind(Object(r.a)(n)),n.handleMouseUp=n.handleMouseUp.bind(Object(r.a)(n)),n.state={drawing:!1,imageData:null,fileName:null},n}return Object(l.a)(e,t),Object(o.a)(e,[{key:"componentDidUpdate",value:function(){this.draw()}},{key:"draw",value:function(){var t=this.refs.canvas,e=t.getContext("2d");if(this.props.dicomLoaded)if(e.clearRect(0,0,t.width,t.height),null!=this.state.imageData&&this.state.fileName===this.props.fileName)e.putImageData(this.state.imageData,0,0);else{for(var n=this.props.pixelDataGray,a=0;a<t.width;a++)for(var o=0;o<t.height;o++){var i=o*t.width+a;e.fillStyle="rgba("+n[i]+","+n[i]+","+n[i]+",1)",e.fillRect(a,o,1,1)}var s=e.getImageData(0,0,t.width,t.height);this.setState({imageData:s,fileName:this.props.fileName})}var r=this.props.history;if(r.length>0){var l=r.length-1,c=r[l].contours,u=r[l].currentContourIdx;e.strokeStyle="red",e.fillStyle="red";for(var h=0;h<c.length;h++){e.beginPath();var d=c[h];e.moveTo(d[0][0],d[0][1]),e.fillRect(d[0][0],d[0][1],1,1);for(var m=0;m<d.length;m++)e.lineTo(d[m][0],d[m][1]);h!==u&&e.lineTo(d[0][0],d[0][1]),e.stroke(),e.closePath()}}}},{key:"handleMouseDown",value:function(t){0===t.button&&this.setState({drawing:!0})}},{key:"handleMouseMove",value:function(t){var e=this.refs.canvas,n=e.getBoundingClientRect(),a=t.clientX-n.left;a=Math.min(Math.max(parseInt(a),0),e.width-1);var o=t.clientY-n.top;o=Math.min(Math.max(parseInt(o),0),e.height-1),this.props.onMouseMove(a,o),this.state.drawing&&this.props.onAddPoint(a,o)}},{key:"handleMouseUp",value:function(t){if(0===t.button){var e=this.refs.canvas.getBoundingClientRect(),n=t.clientX-e.left,a=t.clientY-e.top;this.props.onAddPoint(n,a),this.setState({drawing:!1})}}},{key:"render",value:function(){return u.a.createElement("div",{className:"slice"},u.a.createElement("canvas",{ref:"canvas",width:this.props.width,height:this.props.height,className:"slice-canvas",onMouseMove:this.handleMouseMove,onMouseDown:this.handleMouseDown,onMouseUp:this.handleMouseUp}),u.a.createElement("img",{ref:"dicom",className:"hidden"}))}}]),e}(u.a.Component),y=function(t){function e(t){var n;return Object(a.a)(this,e),(n=Object(i.a)(this,Object(s.a)(e).call(this,t))).fileInput=u.a.createRef(),n.handleDownloadAnnotationClick=n.handleDownloadAnnotationClick.bind(Object(r.a)(n)),n.handleUploadFile=n.handleUploadFile.bind(Object(r.a)(n)),n}return Object(l.a)(e,t),Object(o.a)(e,[{key:"handleDownloadAnnotationClick",value:function(t){var e=this.props.currentContours.filter(g);if(e.length>0){var n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",this.props.fileName+".json"),a.click(),this.props.onAnnotationDownlod()}}},{key:"handleUploadFile",value:function(t){var e=this.fileInput.current.files;if(e.length>0){var n=e[0];this.props.onUploadFile(n)}}},{key:"render",value:function(){var t=this;return u.a.createElement("div",{className:"toolbox"},u.a.createElement("div",{className:"summary"},u.a.createElement("div",null,this.props.fileName),u.a.createElement("div",null,"x: ",this.props.xPos),u.a.createElement("div",null,"y: ",this.props.yPos),u.a.createElement("div",null,"hu: ",this.props.hu),u.a.createElement("div",null,"wc: ",this.props.wc),u.a.createElement("div",null,"ww: ",this.props.ww)),u.a.createElement("div",{className:"upload-dicom-button"},u.a.createElement("button",{onClick:function(){return t.fileInput.current.click()}},"Upload Dicom File"),u.a.createElement("input",{type:"file",onChange:this.handleUploadFile,ref:this.fileInput,style:{display:"none"}})),u.a.createElement("div",{className:"download-annotation-button"},u.a.createElement("button",{onClick:this.handleDownloadAnnotationClick},"Download Annotation")))}}]),e}(u.a.Component);function g(t){return!(t.length<3)}d.a.render(u.a.createElement(f,null),document.getElementById("root"))},16:function(t,e,n){}},[[10,1,2]]]);
//# sourceMappingURL=main.7efa09a3.chunk.js.map